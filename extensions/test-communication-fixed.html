<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Extension Communication Test - Fixed</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        font-weight: bold;
      }
      .success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      .warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }
      .log {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 15px;
        margin: 10px 0;
        font-family: monospace;
        font-size: 12px;
        max-height: 300px;
        overflow-y: auto;
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîß Extension Communication Test - Fixed Version</h1>
      <p>
        This page tests the fixed extension communication using blob URL
        injection and postMessage.
      </p>

      <div id="status" class="status info">
        üîç Testing extension detection...
      </div>

      <div class="test-section">
        <h3>üß™ Test Steps</h3>
        <ol>
          <li>
            <strong>Extension Loaded:</strong>
            <span id="extension-loaded">‚ùå</span>
          </li>
          <li>
            <strong>Communication Bridge:</strong>
            <span id="bridge-status">‚ùå</span>
          </li>
          <li>
            <strong>PostMessage Ping:</strong> <span id="ping-status">‚ùå</span>
          </li>
          <li>
            <strong>Content Script Ping:</strong>
            <span id="content-ping-status">‚ùå</span>
          </li>
        </ol>
      </div>

      <div class="test-section">
        <h3>üéØ Manual Tests</h3>
        <button onclick="testGlobalObject()">Test Global Object</button>
        <button onclick="testPostMessage()">Test PostMessage</button>
        <button onclick="testContentScriptPing()">
          Test Content Script Ping
        </button>
        <button onclick="testUrlAnalysis()">Test URL Analysis</button>
        <button onclick="clearLog()">Clear Log</button>
      </div>

      <div class="test-section">
        <h3>üìã Console Log</h3>
        <div id="log" class="log"></div>
      </div>
    </div>

    <script>
      let extensionDetected = false;
      let bridgeDetected = false;
      let pingResponded = false;
      let contentPingResponded = false;

      // Log function
      function log(message, type = 'info') {
        const logDiv = document.getElementById('log');
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement('div');
        logEntry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> ${message}`;
        logDiv.appendChild(logEntry);
        logDiv.scrollTop = logDiv.scrollHeight;
        console.log(message);
      }

      function clearLog() {
        document.getElementById('log').innerHTML = '';
      }

      // Update status display
      function updateStatus() {
        const statusDiv = document.getElementById('status');
        const extensionLoadedSpan = document.getElementById('extension-loaded');
        const bridgeStatusSpan = document.getElementById('bridge-status');
        const pingStatusSpan = document.getElementById('ping-status');
        const contentPingStatusSpan = document.getElementById(
          'content-ping-status'
        );

        extensionLoadedSpan.textContent = extensionDetected ? '‚úÖ' : '‚ùå';
        bridgeStatusSpan.textContent = bridgeDetected ? '‚úÖ' : '‚ùå';
        pingStatusSpan.textContent = pingResponded ? '‚úÖ' : '‚ùå';
        contentPingStatusSpan.textContent = contentPingResponded ? '‚úÖ' : '‚ùå';

        if (extensionDetected && bridgeDetected) {
          statusDiv.className = 'status success';
          statusDiv.textContent =
            'üéâ Extension detected and communication established!';
        } else if (extensionDetected) {
          statusDiv.className = 'status warning';
          statusDiv.textContent =
            '‚ö†Ô∏è Extension detected but communication bridge not ready';
        } else {
          statusDiv.className = 'status error';
          statusDiv.textContent = '‚ùå Extension not detected';
        }
      }

      // Test global object
      function testGlobalObject() {
        log('üîç Testing global extension object...');
        if (window.redirectinatorExtension) {
          log('‚úÖ Global object found:', window.redirectinatorExtension);
          bridgeDetected = true;
          updateStatus();
        } else {
          log('‚ùå Global object not found');
        }
      }

      // Test postMessage ping
      function testPostMessage() {
        log('üèì Testing postMessage ping...');
        window.postMessage(
          {
            type: 'REDIRECTINATOR_PING',
            timestamp: Date.now(),
          },
          '*'
        );
      }

      // Test content script ping
      function testContentScriptPing() {
        log('üèì Testing content script ping...');
        window.postMessage(
          {
            type: 'REDIRECTINATOR_CONTENT_SCRIPT_PING',
            timestamp: Date.now(),
            requestId: 'test_' + Date.now(),
          },
          '*'
        );
      }

      // Test URL analysis
      function testUrlAnalysis() {
        log('üîó Testing URL analysis...');
        if (window.redirectinatorExtension?.analyzeUrl) {
          log('‚úÖ analyzeUrl method available, testing...');
          window.redirectinatorExtension
            .analyzeUrl('https://example.com')
            .then(result => {
              log('‚úÖ URL analysis successful:', result);
            })
            .catch(error => {
              log('‚ùå URL analysis failed:', error.message);
            });
        } else {
          log('‚ùå analyzeUrl method not available');
        }
      }

      // Listen for extension messages
      window.addEventListener('message', event => {
        if (event.source !== window) return;

        const data = event.data;
        if (!data || !data.type) return;

        log(`üì® Received message: ${data.type}`, 'info');

        switch (data.type) {
          case 'REDIRECTINATOR_EXTENSION_READY':
            log('‚úÖ Extension ready message received:', data);
            extensionDetected = true;
            updateStatus();
            break;

          case 'REDIRECTINATOR_PONG':
            log('üèì PONG received:', data);
            pingResponded = true;
            updateStatus();
            break;

          case 'REDIRECTINATOR_CONTENT_SCRIPT_PONG':
            log('üèì Content script PONG received:', data);
            contentPingResponded = true;
            updateStatus();
            break;

          case 'REDIRECTINATOR_RESPONSE':
            log('üìã Response received:', data);
            break;
        }
      });

      // Auto-test on page load
      window.addEventListener('load', () => {
        log('üöÄ Page loaded, starting auto-tests...');

        // Wait a bit for extension to initialize
        setTimeout(() => {
          log('‚è∞ Starting delayed tests...');
          testGlobalObject();
          testPostMessage();
          testContentScriptPing();
        }, 2000);

        // Check for extension every 2 seconds
        setInterval(() => {
          if (!extensionDetected) {
            testGlobalObject();
          }
        }, 2000);
      });

      // Initial status update
      updateStatus();
    </script>
  </body>
</html>
