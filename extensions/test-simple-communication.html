<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Simple Extension Communication Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        font-weight: bold;
      }
      .success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      .warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      .log {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 15px;
        margin: 10px 0;
        font-family: monospace;
        font-size: 12px;
        max-height: 300px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîß Simple Extension Communication Test</h1>
      <p>
        This page tests the working postMessage communication without relying on
        the bridge injection.
      </p>

      <div id="status" class="status info">
        üîç Testing extension detection via postMessage...
      </div>

      <div>
        <h3>üß™ Test Results</h3>
        <ul>
          <li>
            <strong>Extension Detected:</strong>
            <span id="extension-detected">‚ùå</span>
          </li>
          <li>
            <strong>PostMessage Working:</strong>
            <span id="postmessage-working">‚ùå</span>
          </li>
          <li>
            <strong>Can Analyze URLs:</strong> <span id="can-analyze">‚ùå</span>
          </li>
        </ul>
      </div>

      <div>
        <h3>üéØ Manual Tests</h3>
        <button onclick="testPing()">Test Ping</button>
        <button onclick="testContentScriptPing()">
          Test Content Script Ping
        </button>
        <button onclick="testUrlAnalysis()">Test URL Analysis</button>
        <button onclick="clearLog()">Clear Log</button>
      </div>

      <div>
        <h3>üìã Console Log</h3>
        <div id="log" class="log"></div>
      </div>
    </div>

    <script>
      let extensionDetected = false;
      let postMessageWorking = false;

      // Log function
      function log(message) {
        const logDiv = document.getElementById('log');
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement('div');
        logEntry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> ${message}`;
        logDiv.appendChild(logEntry);
        logDiv.scrollTop = logDiv.scrollHeight;
        console.log(message);
      }

      function clearLog() {
        document.getElementById('log').innerHTML = '';
      }

      // Update status display
      function updateStatus() {
        const statusDiv = document.getElementById('status');
        const extensionDetectedSpan =
          document.getElementById('extension-detected');
        const postMessageWorkingSpan = document.getElementById(
          'postmessage-working'
        );
        const canAnalyzeSpan = document.getElementById('can-analyze');

        extensionDetectedSpan.textContent = extensionDetected ? '‚úÖ' : '‚ùå';
        postMessageWorkingSpan.textContent = postMessageWorking ? '‚úÖ' : '‚ùå';
        canAnalyzeSpan.textContent =
          extensionDetected && postMessageWorking ? '‚úÖ' : '‚ùå';

        if (extensionDetected && postMessageWorking) {
          statusDiv.className = 'status success';
          statusDiv.textContent =
            'üéâ Extension detected and communication working!';
        } else if (extensionDetected) {
          statusDiv.className = 'status warning';
          statusDiv.textContent =
            '‚ö†Ô∏è Extension detected but communication not confirmed';
        } else {
          statusDiv.className = 'status error';
          statusDiv.textContent = '‚ùå Extension not detected';
        }
      }

      // Test ping
      function testPing() {
        log('üèì Testing ping...');
        window.postMessage(
          {
            type: 'REDIRECTINATOR_PING',
            timestamp: Date.now(),
          },
          '*'
        );
      }

      // Test content script ping
      function testContentScriptPing() {
        log('üèì Testing content script ping...');
        window.postMessage(
          {
            type: 'REDIRECTINATOR_CONTENT_SCRIPT_PING',
            timestamp: Date.now(),
            requestId: 'test_' + Date.now(),
          },
          '*'
        );
      }

      // Test URL analysis via postMessage
      function testUrlAnalysis() {
        log('üîó Testing URL analysis via postMessage...');
        const requestId = 'req_' + Date.now();

        window.postMessage(
          {
            type: 'REDIRECTINATOR_REQUEST',
            requestId: requestId,
            url: 'https://example.com',
            options: {},
          },
          '*'
        );

        // Set up response listener
        const responseHandler = event => {
          if (
            event.data?.type === 'REDIRECTINATOR_RESPONSE' &&
            event.data.requestId === requestId
          ) {
            window.removeEventListener('message', responseHandler);
            if (event.data.error) {
              log('‚ùå URL analysis failed:', event.data.error);
            } else {
              log('‚úÖ URL analysis successful:', event.data.result);
            }
          }
        };

        window.addEventListener('message', responseHandler);

        // Timeout after 10 seconds
        setTimeout(() => {
          window.removeEventListener('message', responseHandler);
          log('‚è∞ URL analysis timeout');
        }, 10000);
      }

      // Listen for extension messages
      window.addEventListener('message', event => {
        if (event.source !== window) return;

        const data = event.data;
        if (!data || !data.type) return;

        log(`üì® Received: ${data.type}`);

        switch (data.type) {
          case 'REDIRECTINATOR_PONG':
            log('üèì PONG received:', data);
            extensionDetected = true;
            postMessageWorking = true;
            updateStatus();
            break;

          case 'REDIRECTINATOR_CONTENT_SCRIPT_PONG':
            log('üèì Content script PONG received:', data);
            extensionDetected = true;
            postMessageWorking = true;
            updateStatus();
            break;

          case 'REDIRECTINATOR_EXTENSION_READY':
            log('‚úÖ Extension ready message received:', data);
            extensionDetected = true;
            updateStatus();
            break;
        }
      });

      // Auto-test on page load
      window.addEventListener('load', () => {
        log('üöÄ Page loaded, starting tests...');

        // Wait a bit for extension to initialize
        setTimeout(() => {
          log('‚è∞ Starting delayed tests...');
          testPing();
          testContentScriptPing();
        }, 2000);

        // Check for extension every 3 seconds
        setInterval(() => {
          if (!extensionDetected) {
            log('üîÑ Checking for extension...');
            testPing();
          }
        }, 3000);
      });

      // Initial status update
      updateStatus();
    </script>
  </body>
</html>
